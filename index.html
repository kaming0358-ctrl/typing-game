<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å¤§ä½œæˆ¦ï¼</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Kaisei+Decol:wght@400;700&family=M+PLUS+Rounded+1c:wght@400;700;800&display=swap');

:root {
  --bg: #0d1117;
  --panel: #161b26;
  --panel2: #1c2333;
  --accent: #00e5ff;
  --accent2: #ff6b35;
  --accent3: #a855f7;
  --green: #69f0ae;
  --red: #ff5252;
  --yellow: #ffd740;
  --text: #e8eaf6;
  --f-pinky:  #ff6b6b;
  --f-ring:   #ffa94d;
  --f-middle: #69db7c;
  --f-index:  #4dabf7;
  --f-thumb:  #da77f2;
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'M PLUS Rounded 1c', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

#stars { position:fixed; inset:0; pointer-events:none; z-index:0; }
.star {
  position:absolute; background:white; border-radius:50%;
  animation: twinkle var(--d,3s) ease-in-out infinite alternate;
  animation-delay: var(--dl,0s);
}
@keyframes twinkle { from{opacity:.15} to{opacity:.9} }

.screen {
  position:relative; z-index:1;
  display:flex; flex-direction:column; align-items:center;
  justify-content:center; min-height:100vh; padding:20px;
}
.screen.hidden { display:none; }

.btn {
  background: linear-gradient(135deg, var(--accent), #0288d1);
  border:none; border-radius:50px; padding:14px 48px;
  font-family:'M PLUS Rounded 1c',sans-serif;
  font-size:1.3rem; font-weight:800; color:#000;
  cursor:pointer; transition:transform .15s, box-shadow .15s;
  box-shadow: 0 0 20px rgba(0,229,255,.5);
}
.btn:hover { transform:scale(1.07); box-shadow:0 0 35px rgba(0,229,255,.8); }
.btn:active { transform:scale(.97); }
.btn-sub {
  background: linear-gradient(135deg, var(--accent3), #7c3aed);
  color:white; box-shadow:0 0 20px rgba(168,85,247,.5);
}
.btn-sub:hover { box-shadow:0 0 35px rgba(168,85,247,.8); }

/* ===== ã‚¿ã‚¤ãƒˆãƒ« ===== */
#title-screen h1 {
  font-family:'Kaisei Decol',serif;
  font-size:clamp(2rem,6vw,3.8rem);
  text-align:center; line-height:1.3;
  color:var(--accent);
  text-shadow:0 0 30px var(--accent), 0 0 60px var(--accent);
  animation:glow 2s ease-in-out infinite alternate;
  margin-bottom:.4em;
}
@keyframes glow {
  from{text-shadow:0 0 20px var(--accent);}
  to{text-shadow:0 0 50px var(--accent),0 0 100px var(--accent);}
}
#title-screen p { font-size:1rem; color:#90caf9; margin-bottom:1.5rem; text-align:center; }

.rules-box {
  background:rgba(255,255,255,.04);
  border:1px solid rgba(0,229,255,.2);
  border-radius:14px; padding:16px 24px;
  margin-bottom:1.5rem; max-width:420px; width:100%;
}
.rules-box h3 { color:var(--yellow); font-size:.9rem; margin-bottom:8px; letter-spacing:.1em; }
.rule-item { display:flex; align-items:center; gap:8px; font-size:.85rem; color:#cdd5e0; margin-bottom:5px; }

.finger-legend {
  display:flex; flex-wrap:wrap; gap:8px; justify-content:center;
  background:rgba(255,255,255,.04);
  border:1px solid rgba(255,255,255,.08);
  border-radius:14px; padding:12px 20px;
  margin-bottom:1.5rem; max-width:420px; width:100%;
}
.legend-item { display:flex; align-items:center; gap:6px; font-size:.82rem; }
.legend-dot { width:16px; height:16px; border-radius:50%; }

/* ===== ã‚«ãƒ†ã‚´ãƒªé¸æŠ ===== */
.category-select {
  background:rgba(255,255,255,.04);
  border:1px solid rgba(0,229,255,.2);
  border-radius:14px; padding:16px 20px;
  margin-bottom:1.5rem; max-width:480px; width:100%;
}
.category-select h3 { color:var(--yellow); font-size:.9rem; margin-bottom:12px; letter-spacing:.1em; text-align:center; }
.cat-grid {
  display:grid; grid-template-columns:repeat(3,1fr); gap:8px;
}
.cat-btn {
  background:rgba(255,255,255,.05);
  border:2px solid rgba(255,255,255,.12);
  border-radius:10px; padding:10px 6px;
  font-family:'M PLUS Rounded 1c',sans-serif;
  font-size:.78rem; font-weight:700; color:#cdd5e0;
  cursor:pointer; transition:all .15s; text-align:center;
  line-height:1.4;
}
.cat-btn:hover { background:rgba(0,229,255,.1); border-color:var(--accent); color:var(--accent); }
.cat-btn.selected {
  background:rgba(0,229,255,.18);
  border-color:var(--accent);
  color:var(--accent);
  box-shadow:0 0 12px rgba(0,229,255,.4);
}

/* ===== ã‚²ãƒ¼ãƒ ç”»é¢ ===== */
#game-screen { justify-content:flex-start; padding-top:12px; }

.game-header {
  width:100%; max-width:880px;
  display:flex; align-items:center; justify-content:space-between;
  padding:10px 20px;
  background:rgba(22,27,38,.95);
  border:1px solid rgba(0,229,255,.15);
  border-radius:16px 16px 0 0;
}
.hud-item { text-align:center; }
.hud-label { font-size:.65rem; color:#90caf9; letter-spacing:.1em; text-transform:uppercase; }
.hud-value { font-size:1.5rem; font-weight:800; color:var(--accent); }

#timer-wrap { position:relative; display:inline-block; }
#timer-value { color:var(--accent2); transition:color .3s; }
#timer-value.danger { color:var(--red); animation:blink .4s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.4} }
#penalty-flash {
  position:absolute; top:-18px; left:50%; transform:translateX(-50%);
  color:var(--red); font-size:.75rem; font-weight:800;
  opacity:0; white-space:nowrap; pointer-events:none;
}
#penalty-flash.show { animation:penalty-pop .7s ease-out forwards; }
@keyframes penalty-pop {
  0%  { opacity:1; transform:translateX(-50%) translateY(0); }
  100%{ opacity:0; transform:translateX(-50%) translateY(-20px); }
}

.game-area {
  width:100%; max-width:880px;
  background:var(--panel);
  border:1px solid rgba(0,229,255,.12);
  border-top:none;
  border-radius:0 0 16px 16px;
  padding:16px 16px 14px;
  display:flex; flex-direction:column; align-items:center; gap:14px;
}

.progress-bar-wrap { width:100%; height:5px; background:rgba(255,255,255,.07); border-radius:3px; overflow:hidden; }
.progress-bar-fill {
  height:100%; border-radius:3px;
  background:linear-gradient(90deg,var(--accent),var(--accent3));
  transition:width .5s linear, background .5s;
}

/* ===== ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¹ãƒ†ãƒ¼ã‚¸ ===== */
.monster-stage {
  width:100%; height:160px;
  position:relative; overflow:hidden;
  background:
    radial-gradient(ellipse 80% 40% at 50% 100%, rgba(168,85,247,.18) 0%, transparent 70%),
    linear-gradient(180deg, rgba(5,5,20,1) 0%, rgba(20,14,40,.85) 100%);
  border-radius:12px;
  border:1px solid rgba(168,85,247,.25);
}
.monster-stage::before {
  content:'';
  position:absolute; bottom:0; left:50%; transform:translateX(-50%);
  width:0; height:0;
  border-left:  60vw solid transparent;
  border-right: 60vw solid transparent;
  border-bottom:160px solid rgba(168,85,247,.06);
  pointer-events:none;
}
.monster-stage::after {
  content:'';
  position:absolute; bottom:0; left:0; right:0; height:3px;
  background:linear-gradient(90deg,transparent,rgba(168,85,247,.9),transparent);
}

#monster {
  position:absolute;
  left:50%; bottom:8px;
  transform:translateX(-50%) scale(var(--ms, 0.15));
  transform-origin: bottom center;
  font-size:5rem;
  line-height:1;
  opacity: var(--mo, 0.2);
  filter:drop-shadow(0 0 calc(var(--ms,0.15)*40px) rgba(168,85,247,.9));
  will-change:transform, opacity, filter;
  transition: filter .15s;
}
#monster.hurt {
  filter:drop-shadow(0 0 30px red) brightness(3) !important;
  animation: monster-hurt .3s ease-out;
}
@keyframes monster-hurt {
  0%  { transform:translateX(-50%) scale(var(--ms,1)) skewX(0deg); }
  30% { transform:translateX(-40%) scale(calc(var(--ms,1)*1.1)) skewX(-10deg); }
  100%{ transform:translateX(-50%) scale(var(--ms,1)) skewX(0deg); }
}
#monster.explode {
  animation: explode .45s ease-out forwards !important;
}
@keyframes explode {
  0%  { transform:translateX(-50%) scale(var(--ms,1)); opacity:1; filter:brightness(4) drop-shadow(0 0 30px orange); }
  50% { transform:translateX(-50%) scale(calc(var(--ms,1)*2.5)); opacity:.8; }
  100%{ transform:translateX(-50%) scale(0); opacity:0; }
}

#word-bubble {
  position:absolute;
  left:50%; transform:translateX(-50%);
  background:var(--panel2);
  border:2px solid var(--accent3);
  border-radius:12px;
  padding:6px 16px;
  font-family:'Kaisei Decol',serif;
  font-size:calc(0.8rem + var(--ms,0.15) * 1.4rem);
  font-weight:700;
  color:white;
  white-space:nowrap;
  box-shadow:0 0 16px rgba(168,85,247,.5);
  pointer-events:none;
  transition: bottom .05s, font-size .05s;
}
#word-bubble::after {
  content:'';
  position:absolute; bottom:-10px; left:50%; transform:translateX(-50%);
  border:5px solid transparent;
  border-top-color:var(--accent3);
}

/* ===== å…¥åŠ›ã‚¨ãƒªã‚¢ ===== */
.input-section {
  width:100%;
  background:var(--panel2);
  border:1px solid rgba(0,229,255,.18);
  border-radius:14px;
  padding:14px 20px;
  display:flex; flex-direction:column; align-items:center; gap:8px;
}
.input-display { display:flex; gap:5px; flex-wrap:wrap; justify-content:center; min-height:48px; align-items:center; }
.char-box {
  width:38px; height:44px;
  border:2px solid rgba(255,255,255,.15);
  border-radius:7px;
  display:flex; align-items:center; justify-content:center;
  font-size:1.2rem; font-weight:700;
  background:rgba(255,255,255,.03);
  transition:all .1s;
}
.char-box.ok      { border-color:var(--green);  color:var(--green);  background:rgba(105,240,174,.12); }
.char-box.ng      { border-color:var(--red);    color:var(--red);    background:rgba(255,82,82,.15); animation:shake .3s; }
.char-box.current { border-color:var(--accent); box-shadow:0 0 12px var(--accent); animation:pulse-box 1s infinite; }
@keyframes shake   { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
@keyframes pulse-box { 0%,100%{box-shadow:0 0 7px var(--accent)} 50%{box-shadow:0 0 18px var(--accent)} }

.romaji-guide { font-size:1.05rem; letter-spacing:.18em; min-height:24px; }
.romaji-guide .done { color:var(--green); }
.romaji-guide .next { color:var(--accent); font-weight:700; }
.romaji-guide .rest { color:#3a4455; }

.feedback-msg {
  font-size:1.4rem; font-weight:800; min-height:38px;
  text-align:center; letter-spacing:.05em;
}
.feedback-msg.ok { color:var(--green); text-shadow:0 0 20px var(--green); }
.feedback-msg.ng { color:var(--red);   text-shadow:0 0 20px var(--red); }

.next-key-hint { font-size:.82rem; color:#90caf9; min-height:22px; text-align:center; }
.finger-tag { display:inline-block; padding:2px 10px; border-radius:20px; font-weight:700; font-size:.78rem; }

/* ===== ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ ===== */
#license-screen .license-box {
  background:var(--panel);
  border:1px solid rgba(0,229,255,.25);
  border-radius:20px; padding:40px 36px;
  width:100%; max-width:400px; text-align:center;
  box-shadow:0 0 40px rgba(0,229,255,.1);
}
.license-icon { font-size:3rem; margin-bottom:12px; }
#license-screen h2 {
  font-family:'Kaisei Decol',serif; font-size:1.6rem;
  color:var(--accent); margin-bottom:8px;
}
#license-screen p { font-size:.88rem; color:#90caf9; margin-bottom:20px; }
#license-input {
  background:var(--panel2);
  border:2px solid rgba(0,229,255,.3);
  border-radius:10px; padding:12px 16px;
  font-family:'M PLUS Rounded 1c',sans-serif;
  font-size:1.1rem; color:white; width:100%;
  outline:none; margin-bottom:10px; text-align:center;
  letter-spacing:.15em;
}
#license-input:focus { border-color:var(--accent); box-shadow:0 0 12px rgba(0,229,255,.3); }
.license-error {
  color:var(--red); font-size:.85rem; font-weight:700;
  min-height:24px; margin-bottom:12px;
  text-shadow:0 0 10px var(--red);
}

/* ===== ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ ===== */
.keyboard-wrap {
  width:100%;
  background:rgba(0,0,0,.3);
  border:1px solid rgba(255,255,255,.07);
  border-radius:14px;
  padding:14px 12px 12px;
  overflow-x:auto;
}
.keyboard { display:flex; flex-direction:column; gap:6px; min-width:600px; }
.kb-row   { display:flex; gap:6px; }

.key {
  height:52px; min-width:52px;
  border-radius:9px;
  border:2px solid rgba(255,255,255,.1);
  display:flex; align-items:center; justify-content:center;
  font-size:1rem; font-weight:800;
  color:rgba(255,255,255,.4);
  background:rgba(255,255,255,.04);
  transition:all .08s;
  cursor:default; flex-shrink:0; position:relative;
  box-shadow: 0 3px 0 rgba(0,0,0,.4);
}
.key.f-pinky  { background:rgba(255,107,107,.18); border-color:rgba(255,107,107,.45); color:var(--f-pinky); box-shadow:0 3px 0 rgba(255,107,107,.2); }
.key.f-ring   { background:rgba(255,169, 77,.18); border-color:rgba(255,169, 77,.45); color:var(--f-ring);  box-shadow:0 3px 0 rgba(255,169,77,.2); }
.key.f-middle { background:rgba(105,219,124,.18); border-color:rgba(105,219,124,.45); color:var(--f-middle);box-shadow:0 3px 0 rgba(105,219,124,.2); }
.key.f-index  { background:rgba( 77,171,247,.18); border-color:rgba( 77,171,247,.45); color:var(--f-index); box-shadow:0 3px 0 rgba(77,171,247,.2); }
.key.f-thumb  { background:rgba(218,119,242,.18); border-color:rgba(218,119,242,.45); color:var(--f-thumb); box-shadow:0 3px 0 rgba(218,119,242,.2); }

.key.home-key::after {
  content:''; position:absolute; bottom:5px; left:50%; transform:translateX(-50%);
  width:7px; height:3px; border-radius:2px; background:currentColor; opacity:.8;
}
.key.active-key {
  transform:scale(1.18) translateY(-2px);
  box-shadow:0 0 22px currentColor, 0 0 8px currentColor, 0 5px 0 rgba(0,0,0,.3);
  color:white !important; z-index:2;
}
.key.pressed { transform:scale(.88) translateY(3px); box-shadow:none; opacity:.6; }
.key.space { flex:1; min-width:200px; font-size:.8rem; color:rgba(255,255,255,.3); }

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ===== */
#ranking-screen .panel {
  background:var(--panel);
  border:1px solid rgba(0,229,255,.2);
  border-radius:20px; padding:28px;
  width:100%; max-width:480px; text-align:center;
}
#ranking-screen h2 {
  font-family:'Kaisei Decol',serif; font-size:1.9rem; color:var(--accent2);
  text-shadow:0 0 20px var(--accent2); margin-bottom:4px;
}
.final-score-big {
  font-size:3rem; font-weight:800; color:var(--green);
  text-shadow:0 0 30px var(--green); margin:8px 0 4px;
}
.final-stats { font-size:.85rem; color:#90caf9; margin-bottom:16px; }

.name-area { display:flex; gap:8px; justify-content:center; margin-bottom:16px; flex-wrap:wrap; }
.name-area input {
  background:var(--panel2);
  border:2px solid rgba(0,229,255,.35);
  border-radius:10px; padding:9px 14px;
  font-family:'M PLUS Rounded 1c',sans-serif;
  font-size:1rem; color:white; width:180px; outline:none;
}
.name-area input:focus { border-color:var(--accent); }

.rank-list { margin:0 0 16px; }
.rank-item {
  display:grid; grid-template-columns:30px 24px 1fr auto auto;
  align-items:center; gap:8px;
  padding:9px 12px; border-radius:9px; margin-bottom:5px;
  background:rgba(255,255,255,.03);
  border:1px solid rgba(255,255,255,.06);
  font-size:.9rem;
}
.rank-item.me {
  background:rgba(0,229,255,.09);
  border-color:rgba(0,229,255,.4);
}
.rank-num   { font-size:.95rem; font-weight:800; color:var(--accent2); }
.rank-medal { font-size:1.2rem; }
.rank-name  { text-align:left; font-weight:700; }
.rank-score { font-weight:800; color:var(--green); white-space:nowrap; }
.rank-acc   { font-size:.75rem; color:#90caf9; white-space:nowrap; }

.btn-row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }

/* ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ« */
.particle {
  position:fixed; pointer-events:none; z-index:200;
  border-radius:50%; animation:fly var(--dur,.7s) ease-out forwards;
}
@keyframes fly {
  0%  { transform:translate(0,0) scale(1); opacity:1; }
  100%{ transform:translate(var(--tx),var(--ty)) scale(0); opacity:0; }
}

/* ã‚¬ã‚¤ãƒ‰ */
#guide-screen .panel {
  background:var(--panel); border:1px solid rgba(0,229,255,.2);
  border-radius:20px; padding:28px; width:100%; max-width:660px;
}
#guide-screen h2 {
  font-family:'Kaisei Decol',serif; font-size:1.7rem; color:var(--accent);
  text-shadow:0 0 20px var(--accent); margin-bottom:16px; text-align:center;
}
.guide-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:16px; }
.guide-card {
  background:var(--panel2); border-radius:10px; padding:12px;
  border:1px solid rgba(255,255,255,.05);
}
.guide-card h3 { font-size:.85rem; margin-bottom:6px; }
.guide-card p  { font-size:.78rem; color:#90caf9; line-height:1.6; }
.hand-diagram  { display:flex; gap:24px; justify-content:center; margin:14px 0; }
.hand { display:flex; flex-direction:column; align-items:center; gap:4px; }
.hand-label { font-size:.72rem; color:#90caf9; }
.fingers { display:flex; gap:3px; }
.finger {
  width:26px; height:56px; border-radius:13px 13px 7px 7px;
  display:flex; align-items:flex-end; justify-content:center;
  padding-bottom:3px; font-size:.58rem; font-weight:700; color:rgba(0,0,0,.75);
}
.thumb { width:22px; height:32px; border-radius:7px; margin-top:24px; }

/* ===== ã‚³ãƒ³ãƒœè¡¨ç¤º ===== */
#combo-wrap {
  display:flex; flex-direction:column; align-items:center;
  position:relative;
}
#combo-value {
  font-size:1.5rem; font-weight:800;
  color:var(--yellow);
  transition: transform .15s, color .2s;
}
#combo-value.level1 { color:var(--green); }
#combo-value.level2 { color:var(--accent2); text-shadow:0 0 12px var(--accent2); }
#combo-value.level3 { color:var(--red); text-shadow:0 0 18px var(--red); animation:combo-fire .6s infinite alternate; }
@keyframes combo-fire {
  from { text-shadow:0 0 10px var(--red); transform:scale(1); }
  to   { text-shadow:0 0 28px var(--red),0 0 50px orange; transform:scale(1.12); }
}
#combo-value.bump { animation:combo-bump .18s ease-out; }
@keyframes combo-bump {
  0%  { transform:scale(1); }
  50% { transform:scale(1.4); }
  100%{ transform:scale(1); }
}
#combo-reset-flash {
  position:absolute; bottom:-16px; left:50%; transform:translateX(-50%);
  color:var(--red); font-size:.65rem; font-weight:800;
  white-space:nowrap; opacity:0; pointer-events:none;
}
#combo-reset-flash.show { animation:penalty-pop .6s ease-out forwards; }

/* ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
.score-popup {
  position:fixed; pointer-events:none; z-index:300;
  font-family:'M PLUS Rounded 1c',sans-serif;
  font-weight:800; font-size:1.3rem;
  color:var(--yellow);
  text-shadow:0 0 10px var(--yellow);
  animation:score-fly .9s ease-out forwards;
  white-space:nowrap;
}
@keyframes score-fly {
  0%  { transform:translateY(0) scale(1); opacity:1; }
  100%{ transform:translateY(-70px) scale(.7); opacity:0; }
}

@media(max-width:640px){
  .key{height:42px;min-width:40px;font-size:.85rem;}
  .key.space{min-width:120px;}
  #monster{font-size:4rem;}
}
</style>
</head>
<body>

<div id="stars"></div>

<!-- ========== ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ ========== -->
<div id="license-screen" class="screen">
  <div class="license-box">
    <div class="license-icon">ğŸ”‘</div>
    <h2>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼</h2>
    <p>ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
    <input type="password" id="license-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="32" autocomplete="off"
      onkeydown="if(event.key==='Enter') checkLicense()">
    <div id="license-error" class="license-error"></div>
    <button class="btn" onclick="checkLicense()">èªè¨¼ã™ã‚‹</button>
  </div>
</div>

<!-- ========== ã‚¿ã‚¤ãƒˆãƒ« ========== -->
<div id="title-screen" class="screen">
  <h1>ğŸ‰ ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼<br>ã‚¿ã‚¤ãƒ”ãƒ³ã‚°å¤§ä½œæˆ¦ï¼</h1>
  <p>ã‚„ã£ã¦ãã‚‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’æ­£ã—ã„æŒ‡ã§ãŸãŠã›ï¼</p>

  <div class="rules-box">
    <h3>âš¡ ãƒ«ãƒ¼ãƒ«</h3>
    <div class="rule-item">â±ï¸ åˆ¶é™æ™‚é–“ã¯ <strong style="color:var(--accent2)">60ç§’</strong></div>
    <div class="rule-item">âŒ ãƒŸã‚¹ã‚¿ã‚¤ãƒ—ã™ã‚‹ã¨ <strong style="color:var(--red)">ï¼2ç§’</strong> ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼</div>
    <div class="rule-item">ğŸ¯ æ­£ã—ã„æŒ‡ã§ã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚’ãŸãŠãã†ï¼</div>
    <div class="rule-item">ğŸ† ã‚¹ã‚³ã‚¢ã¯ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«æ®‹ã‚‹ã‚ˆï¼</div>
  </div>

  <div class="finger-legend">
    <div class="legend-item"><div class="legend-dot" style="background:var(--f-pinky)"></div>å°æŒ‡</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--f-ring)"></div>è–¬æŒ‡</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--f-middle)"></div>ä¸­æŒ‡</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--f-index)"></div>äººå·®ã—æŒ‡</div>
    <div class="legend-item"><div class="legend-dot" style="background:var(--f-thumb)"></div>ãŠã‚„ã‚†ã³</div>
  </div>

  <div class="category-select">
    <h3>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªã‚’ãˆã‚‰ã¼ã†ï¼</h3>
    <div class="cat-grid" id="cat-grid"></div>
  </div>

  <button class="btn" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
  <button class="btn btn-sub" onclick="showGuide()" style="margin-top:10px">ğŸ“– ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ã‚¬ã‚¤ãƒ‰</button>
</div>

<!-- ========== ã‚¬ã‚¤ãƒ‰ ========== -->
<div id="guide-screen" class="screen hidden">
  <div class="panel">
    <h2>ğŸ–ï¸ ãƒ›ãƒ¼ãƒ ãƒã‚¸ã‚·ãƒ§ãƒ³ã¨ã¯ï¼Ÿ</h2>
    <p style="text-align:center;color:#90caf9;margin-bottom:12px;font-size:.88rem">ã‚¿ã‚¤ãƒ”ãƒ³ã‚°ã®ã¨ãã€æŒ‡ã‚’ã„ã¤ã‚‚ã“ã“ã«ã‚‚ã©ã™ã‚ˆï¼</p>
    <div class="hand-diagram">
      <div class="hand">
        <div class="fingers">
          <div class="finger" style="background:var(--f-pinky)">å°</div>
          <div class="finger" style="background:var(--f-ring)">è–¬</div>
          <div class="finger" style="background:var(--f-middle)">ä¸­</div>
          <div class="finger" style="background:var(--f-index)">äºº</div>
          <div class="thumb finger" style="background:var(--f-thumb)">è¦ª</div>
        </div>
        <div class="hand-label">ã²ã ã‚Šæ‰‹ï¼šA S D F</div>
      </div>
      <div class="hand">
        <div class="fingers">
          <div class="thumb finger" style="background:var(--f-thumb)">è¦ª</div>
          <div class="finger" style="background:var(--f-index)">äºº</div>
          <div class="finger" style="background:var(--f-middle)">ä¸­</div>
          <div class="finger" style="background:var(--f-ring)">è–¬</div>
          <div class="finger" style="background:var(--f-pinky)">å°</div>
        </div>
        <div class="hand-label">ã¿ãæ‰‹ï¼šJ K L ï¼›</div>
      </div>
    </div>
    <div class="guide-grid">
      <div class="guide-card">
        <h3 style="color:var(--f-pinky)">ğŸ©· å°æŒ‡</h3>
        <p>å·¦ï¼šAãƒ»Qãƒ»Z<br>å³ï¼šï¼›ãƒ»Pãƒ»ï¼</p>
      </div>
      <div class="guide-card">
        <h3 style="color:var(--f-ring)">ğŸ§¡ è–¬æŒ‡</h3>
        <p>å·¦ï¼šSãƒ»Wãƒ»X<br>å³ï¼šLãƒ»Oãƒ».</p>
      </div>
      <div class="guide-card">
        <h3 style="color:var(--f-middle)">ğŸ’š ä¸­æŒ‡</h3>
        <p>å·¦ï¼šDãƒ»Eãƒ»C<br>å³ï¼šKãƒ»Iãƒ»,</p>
      </div>
      <div class="guide-card">
        <h3 style="color:var(--f-index)">ğŸ’™ äººå·®ã—æŒ‡</h3>
        <p>å·¦ï¼šFãƒ»Gãƒ»Rãƒ»Tãƒ»Vãƒ»B<br>å³ï¼šJãƒ»Hãƒ»Uãƒ»Yãƒ»Mãƒ»N</p>
      </div>
    </div>
    <p style="text-align:center;color:#b0bec5;font-size:.78rem;margin-bottom:14px">
      âš¡ Fã‚­ãƒ¼ã¨Jã‚­ãƒ¼ã«ã¯å°ã•ãªã§ã£ã±ã‚ŠãŒã‚ã‚‹ã‚ˆï¼ã•ã‚ã£ã¦ãŸã—ã‹ã‚ã‚ˆã†ã€‚
    </p>
    <div style="text-align:center"><button class="btn" onclick="showTitle()">ã‚‚ã©ã‚‹</button></div>
  </div>
</div>

<!-- ========== ã‚²ãƒ¼ãƒ  ========== -->
<div id="game-screen" class="screen hidden">
  <div class="game-header">
    <div class="hud-item">
      <div class="hud-label">ãŸãŠã—ãŸæ•°</div>
      <div class="hud-value" id="kill-value">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">ã‚¹ã‚³ã‚¢</div>
      <div class="hud-value" id="score-value">0</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">ã›ã„ã‹ã„ã‚Šã¤</div>
      <div class="hud-value" id="acc-value">100%</div>
    </div>
    <div class="hud-item">
      <div class="hud-label">ã‚³ãƒ³ãƒœ</div>
      <div id="combo-wrap">
        <div class="hud-value" id="combo-value">0</div>
        <div id="combo-reset-flash">ãƒªã‚»ãƒƒãƒˆï¼</div>
      </div>
    </div>
    <div class="hud-item">
      <div class="hud-label">ã®ã“ã‚Šæ™‚é–“</div>
      <div id="timer-wrap">
        <div class="hud-value" id="timer-value">60</div>
        <div id="penalty-flash">ï¼2ç§’ï¼</div>
      </div>
    </div>
  </div>

  <div class="game-area">
    <div class="progress-bar-wrap">
      <div class="progress-bar-fill" id="progress-bar" style="width:100%"></div>
    </div>

    <div class="monster-stage" id="monster-stage">
      <div id="word-bubble">ï¼Ÿ</div>
      <div id="monster">ğŸ‰</div>
    </div>

    <div class="input-section">
      <div class="input-display" id="input-display"></div>
      <div class="romaji-guide" id="romaji-guide"></div>
      <div class="feedback-msg" id="feedback-msg"></div>
      <div class="next-key-hint" id="next-key-hint"></div>
    </div>

    <div class="keyboard-wrap">
      <div class="keyboard" id="keyboard"></div>
    </div>
  </div>
</div>

<!-- ========== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ========== -->
<div id="ranking-screen" class="screen hidden">
  <div class="panel">
    <h2>ğŸ† ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
    <div class="final-score-big" id="final-score">0pt</div>
    <div class="final-stats" id="final-stats"></div>

    <div class="name-area" id="name-area">
      <input type="text" id="player-name" placeholder="ãªã¾ãˆã‚’å…¥ã‚Œã¦ã­" maxlength="8">
      <button class="btn" style="padding:9px 20px;font-size:.95rem" onclick="saveRanking()">ç™»éŒ²ï¼</button>
    </div>

    <div class="rank-list" id="rank-list"></div>

    <div class="btn-row">
      <button class="btn" onclick="startGame()">ã‚‚ã†ä¸€å›ï¼</button>
      <button class="btn btn-sub" onclick="showTitle()">ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
    </div>
  </div>
</div>

<script>
// =============================================
//  å®šæ•°
// =============================================
const TOTAL_TIME  = 60;
const PENALTY_SEC = 2;
const WALK_DURATION_MS = 10000;

const MONSTERS = ['ğŸ‰','ğŸ‘¾','ğŸ§Ÿ','ğŸ¦–','ğŸ‘¹','ğŸ²','ğŸ¤–','ğŸ‘»','ğŸ¦•','ğŸ˜ˆ','ğŸ§Œ','ğŸŠ'];

const WORDS = [
  {word:'ã†ã¿',    romaji:'umi',       hint:'æµ·'},
  {word:'ãã‚‰',    romaji:'sora',      hint:'ç©º'},
  {word:'ã»ã—',    romaji:'hosi',      hint:'æ˜Ÿ'},
  {word:'ã¤ã',    romaji:'tuki',      hint:'æœˆ'},
  {word:'ã¯ãª',    romaji:'hana',      hint:'èŠ±'},
  {word:'ã‹ãœ',    romaji:'kaze',      hint:'é¢¨'},
  {word:'ã‚†ã',    romaji:'yuki',      hint:'é›ª'},
  {word:'ãã‚‚',    romaji:'kumo',      hint:'é›²'},
  {word:'ã‹ã‚',    romaji:'kawa',      hint:'å·'},
  {word:'ã‚‚ã‚Š',    romaji:'mori',      hint:'æ£®'},
  {word:'ã‚„ã¾',    romaji:'yama',      hint:'å±±'},
  {word:'ã¿ãš',    romaji:'mizu',      hint:'æ°´'},
  {word:'ã²ã‹ã‚Š',  romaji:'hikari',    hint:'å…‰'},
  {word:'ã«ã˜',    romaji:'nizi',      hint:'è™¹'},
  {word:'ã„ãªãšã¾',romaji:'inazuma',   hint:'ç¨²å¦»'},
  {word:'ãŸã„ã‚ˆã†',romaji:'taiyou',    hint:'å¤ªé™½'},
  {word:'ã¡ãã‚…ã†',romaji:'tikyuu',    hint:'åœ°çƒ'},
  {word:'ã†ã¡ã‚…ã†',romaji:'utyuu',     hint:'å®‡å®™'},
  {word:'ãƒ­ã‚±ãƒƒãƒˆ',romaji:'roketto',   hint:'å®‡å®™èˆ¹'},
  {word:'ã›ã„ã–',  romaji:'seiza',     hint:'æ˜Ÿåº§'},
  {word:'ãã‚“ãŒ',  romaji:'ginga',     hint:'éŠ€æ²³'},
  {word:'ãŸã‚“ã‘ã‚“',romaji:'tannken',   hint:'æ¢æ¤œ'},
  {word:'ã¼ã†ã‘ã‚“',romaji:'bounnken',  hint:'å†’é™º'},
  {word:'ã‹ãŒã',  romaji:'kagaku',    hint:'ç§‘å­¦'},
  {word:'ã§ã‚“ã',  romaji:'dennki',    hint:'é›»æ°—'},
  {word:'ã²ã“ã†ã',romaji:'hikouki',   hint:'é£›è¡Œæ©Ÿ'},
  {word:'ã—ã‚“ã‹ã‚“ã›ã‚“',romaji:'sinkannsenn',hint:'æ–°å¹¹ç·š'},
  {word:'ã©ã†ã¶ã¤',romaji:'doubutu',   hint:'å‹•ç‰©'},
  {word:'ã—ãœã‚“',  romaji:'sizenn',    hint:'è‡ªç„¶'},
  {word:'ãŸã„ã‘ã‚“',romaji:'taikenn',   hint:'ä½“é¨“'},
  {word:'ã„ã¬',    romaji:'inu',       hint:'ğŸ•çŠ¬'},
  {word:'ã­ã“',    romaji:'neko',      hint:'ğŸˆçŒ«'},
  {word:'ã†ã•ã',  romaji:'usagi',     hint:'ğŸ°ã†ã•ã'},
  {word:'ãã¾',    romaji:'kuma',      hint:'ğŸ»ç†Š'},
  {word:'ã¨ã‚‰',    romaji:'tora',      hint:'ğŸ¯è™'},
  {word:'ãã†',    romaji:'zou',       hint:'ğŸ˜è±¡'},
  {word:'ãã‚Šã‚“',  romaji:'kirinn',    hint:'ğŸ¦’ã‚­ãƒªãƒ³'},
  {word:'ãºã‚“ãã‚“',romaji:'pennginn',  hint:'ğŸ§ãƒšãƒ³ã‚®ãƒ³'},
  {word:'ã”ã‚Šã‚‰',  romaji:'gorira',    hint:'ğŸ¦ã‚´ãƒªãƒ©'},
  {word:'ã‚‰ã„ãŠã‚“',romaji:'raionn',    hint:'ğŸ¦ãƒ©ã‚¤ã‚ªãƒ³'},
  {word:'ã”ã¯ã‚“',  romaji:'gohann',    hint:'ğŸšã”ã¯ã‚“'},
  {word:'ã™ã—',    romaji:'susi',      hint:'ğŸ£ã™ã—'},
  {word:'ã†ã©ã‚“',  romaji:'udonn',     hint:'ã†ã©ã‚“'},
  {word:'ãã°',    romaji:'soba',      hint:'ãã°'},
  {word:'ã‚Šã‚“ã”',  romaji:'rinngo',    hint:'ğŸã‚Šã‚“ã”'},
  {word:'ãƒãƒŠãƒŠ',  romaji:'banana',    hint:'ğŸŒãƒãƒŠãƒŠ'},
  {word:'ã„ã¡ã”',  romaji:'itigo',     hint:'ğŸ“ã„ã¡ã”'},
  {word:'ã™ã„ã‹',  romaji:'suika',     hint:'ğŸ‰ã™ã„ã‹'},
  {word:'ã‚µãƒƒã‚«ãƒ¼',romaji:'sakka-',    hint:'âš½ã‚µãƒƒã‚«ãƒ¼'},
  {word:'ã‚„ãã‚…ã†',romaji:'yakyuu',    hint:'âš¾é‡çƒ'},
  {word:'ãƒ†ãƒ‹ã‚¹',  romaji:'tenisu',    hint:'ğŸ¾ãƒ†ãƒ‹ã‚¹'},
  {word:'school',  romaji:'school',    hint:'ğŸ«å­¦æ ¡'},
  {word:'apple',   romaji:'apple',     hint:'ğŸã‚Šã‚“ã”'},
  {word:'banana',  romaji:'banana',    hint:'ğŸŒãƒãƒŠãƒŠ'},
  {word:'happy',   romaji:'happy',     hint:'ğŸ˜Šã—ã‚ã‚ã›'},
  {word:'friend',  romaji:'friend',    hint:'ğŸ‘«ã¨ã‚‚ã ã¡'},
  {word:'music',   romaji:'music',     hint:'ğŸµãŠã‚“ãŒã'},
  {word:'dream',   romaji:'dream',     hint:'ğŸ’­ã‚†ã‚'},
  {word:'heart',   romaji:'heart',     hint:'â¤ï¸ã“ã“ã‚'},
];

const KEY_FINGER = {
  '1':'f-pinky','2':'f-ring','3':'f-middle','4':'f-index','5':'f-index',
  '6':'f-index','7':'f-index','8':'f-middle','9':'f-ring','0':'f-pinky',
  '-':'f-pinky','^':'f-pinky','\\':'f-pinky',
  'q':'f-pinky','w':'f-ring','e':'f-middle','r':'f-index','t':'f-index',
  'y':'f-index','u':'f-index','i':'f-middle','o':'f-ring','p':'f-pinky','@':'f-pinky',
  'a':'f-pinky','s':'f-ring','d':'f-middle','f':'f-index','g':'f-index',
  'h':'f-index','j':'f-index','k':'f-middle','l':'f-ring',';':'f-pinky',':':'f-pinky',
  'z':'f-pinky','x':'f-ring','c':'f-middle','v':'f-index','b':'f-index',
  'n':'f-index','m':'f-index',',':'f-middle','.':'f-ring','/':'f-pinky',
  ' ':'f-thumb',
};
const FINGER_NAMES  = {'f-pinky':'å°æŒ‡','f-ring':'è–¬æŒ‡','f-middle':'ä¸­æŒ‡','f-index':'äººå·®ã—æŒ‡','f-thumb':'ãŠã‚„ã‚†ã³'};
const FINGER_COLORS = {
  'f-pinky':'var(--f-pinky)','f-ring':'var(--f-ring)','f-middle':'var(--f-middle)',
  'f-index':'var(--f-index)','f-thumb':'var(--f-thumb)'
};
const HOME_KEYS = ['a','s','d','f','j','k','l',';'];

const KB_ROWS = [
  ['1','2','3','4','5','6','7','8','9','0','-','^'],
  ['q','w','e','r','t','y','u','i','o','p','@'],
  ['a','s','d','f','g','h','j','k','l',';',':'],
  ['z','x','c','v','b','n','m',',','.','/'],
  ['space'],
];

// =============================================
//  ã‚²ãƒ¼ãƒ çŠ¶æ…‹å¤‰æ•°
// =============================================
let score=0, kills=0, totalTyped=0, correctTyped=0;
let timerSec=TOTAL_TIME, timerInterval=null;
let gameActive=false;
let currentWord=null, charIdx=0, wordIdx=0;
let wordPool=[];
let monsterRafId=null, monsterStartTime=0;
let combo=0;
let wordStarted=false, wordStartTime=0;
let lastSavedScore=null;
let feedbackTimer=null;

// =============================================
//  åˆæœŸåŒ–
// =============================================
function initStars(){
  const c=document.getElementById('stars');
  for(let i=0;i<120;i++){
    const s=document.createElement('div');
    s.className='star';
    const sz=Math.random()*2.5+0.5;
    s.style.cssText=
      `width:${sz}px;height:${sz}px;`+
      `left:${Math.random()*100}%;top:${Math.random()*100}%;`+
      `--d:${(Math.random()*3+1).toFixed(1)}s;`+
      `--dl:${(Math.random()*4).toFixed(1)}s;`+
      `opacity:${(Math.random()*.5+.1).toFixed(2)}`;
    c.appendChild(s);
  }
}

function buildKeyboard(){
  const kb=document.getElementById('keyboard');
  kb.innerHTML='';
  KB_ROWS.forEach(row=>{
    const rowEl=document.createElement('div');
    rowEl.className='kb-row';
    row.forEach(k=>{
      const el=document.createElement('div');
      el.className='key';
      if(k==='space'){
        el.classList.add('space','f-thumb');
        el.textContent='ã‚¹ãƒšãƒ¼ã‚¹';
        el.id='key-space';
      } else {
        const fc=KEY_FINGER[k]||'';
        if(fc) el.classList.add(fc);
        if(HOME_KEYS.includes(k)) el.classList.add('home-key');
        el.textContent=k.toUpperCase();
        el.id='key-'+k;
      }
      rowEl.appendChild(el);
    });
    kb.appendChild(rowEl);
  });
}

// =============================================
//  ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼
// =============================================
// â˜…ã“ã“ã®ã‚­ãƒ¼ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„â˜…
const LICENSE_KEY = 'MONSTER2025';

function checkLicense(){
  const input = document.getElementById('license-input').value.trim().toUpperCase();
  const errEl = document.getElementById('license-error');
  if(input === LICENSE_KEY.toUpperCase()){
    errEl.textContent = '';
    showScreen('title-screen');
  } else {
    errEl.textContent = 'âŒ ã‚­ãƒ¼ãŒé•ã„ã¾ã™ã€‚ã‚‚ã†ä¸€åº¦ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    document.getElementById('license-input').value = '';
    document.getElementById('license-input').focus();
  }
}

// =============================================
//  ç”»é¢åˆ‡æ›¿
// =============================================
function showScreen(id){
  ['license-screen','title-screen','guide-screen','game-screen','ranking-screen']
    .forEach(s=>document.getElementById(s).classList.toggle('hidden',s!==id));
}
function showTitle(){ stopGame(); showScreen('license-screen'); }
function showGuide(){ showScreen('guide-screen'); }

// =============================================
//  ã‚²ãƒ¼ãƒ é–‹å§‹
// =============================================
function startGame(){
  score=0; kills=0; totalTyped=0; correctTyped=0;
  timerSec=TOTAL_TIME; wordIdx=0; charIdx=0;
  gameActive=true; lastSavedScore=null;
  combo=0; wordStarted=false;

  const sourceWords = selectedCategory === 'all'
    ? WORDS
    : WORDS.filter(w => w.cat === selectedCategory);
  const pool = sourceWords.length > 0 ? sourceWords : WORDS;
  wordPool=shuffle([...pool]).concat(shuffle([...pool])).concat(shuffle([...pool]));

  const tv=document.getElementById('timer-value');
  tv.style.color='var(--accent2)';
  tv.classList.remove('danger');

  showScreen('game-screen');
  updateHUD();
  loadWord();
  startTimer();
}

function stopGame(){
  gameActive=false;
  clearInterval(timerInterval);
  cancelAnimationFrame(monsterRafId);
}

// =============================================
//  ã‚¿ã‚¤ãƒãƒ¼
// =============================================
function startTimer(){
  clearInterval(timerInterval);
  timerInterval=setInterval(()=>{
    if(!gameActive) return;
    timerSec=Math.max(0, timerSec-1);
    updateTimerUI();
    if(timerSec<=0) endGame();
  },1000);
}

function updateTimerUI(){
  const el=document.getElementById('timer-value');
  el.textContent=timerSec;
  el.classList.toggle('danger', timerSec<=10);
  const pct=timerSec/TOTAL_TIME;
  const pb=document.getElementById('progress-bar');
  pb.style.width=(pct*100)+'%';
  pb.style.background=pct>.4
    ?'linear-gradient(90deg,var(--accent),var(--accent3))'
    :'linear-gradient(90deg,#ff9800,var(--red))';
}

function applyPenalty(){
  timerSec=Math.max(0, timerSec-PENALTY_SEC);
  updateTimerUI();
  const pf=document.getElementById('penalty-flash');
  pf.classList.remove('show');
  void pf.offsetWidth;
  pf.classList.add('show');
  if(timerSec<=0) endGame();
}

// =============================================
//  å˜èªãƒ­ãƒ¼ãƒ‰
// =============================================
function loadWord(){
  if(!gameActive) return;
  if(wordIdx>=wordPool.length){
    const sourceWords = selectedCategory === 'all'
      ? WORDS
      : WORDS.filter(w => w.cat === selectedCategory);
    const pool = sourceWords.length > 0 ? sourceWords : WORDS;
    wordPool=shuffle([...pool]).concat(shuffle([...pool]));
    wordIdx=0;
  }
  currentWord=wordPool[wordIdx++];
  charIdx=0;
  wordStarted=false;

  const monEl=document.getElementById('monster');
  const bubble=document.getElementById('word-bubble');
  const stage=document.getElementById('monster-stage');

  monEl.className='';
  monEl.textContent=MONSTERS[Math.floor(Math.random()*MONSTERS.length)];
  bubble.textContent=currentWord.word+'ï¼ˆ'+currentWord.hint+'ï¼‰';
  bubble.style.opacity='1';

  setMonsterPos(monEl, bubble, stage, 1.0);
  startMonsterWalk(stage, monEl, bubble);

  const disp=document.getElementById('input-display');
  disp.innerHTML='';
  currentWord.romaji.split('').forEach((_,i)=>{
    const b=document.createElement('div');
    b.className='char-box'+(i===0?' current':'');
    b.id='cb-'+i;
    disp.appendChild(b);
  });

  updateRomajiGuide();
  highlightNextKey();
  clearFeedback();
}

// =============================================
//  ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼æ­©è¡Œã‚¢ãƒ‹ãƒ¡
// =============================================
function startMonsterWalk(stage, monEl, bubble){
  cancelAnimationFrame(monsterRafId);
  monsterStartTime=performance.now();

  function step(ts){
    if(!gameActive) return;
    const elapsed=ts-monsterStartTime;
    const ratio=1.0-(elapsed/WALK_DURATION_MS);

    if(ratio<=0){
      onMonsterReached();
      return;
    }
    setMonsterPos(monEl, bubble, stage, ratio);
    monsterRafId=requestAnimationFrame(step);
  }
  monsterRafId=requestAnimationFrame(step);
}

function setMonsterPos(monEl, bubble, stage, ratio){
  const progress = 1.0 - ratio;
  const scale = 0.12 + 0.88 * (progress * progress);
  const opacity = 0.15 + 0.85 * progress;
  const sh = stage.offsetHeight || 160;
  const bottomPx = 6 + (sh - 70) * (1 - progress * progress);

  monEl.style.setProperty('--ms', scale);
  monEl.style.setProperty('--mo', opacity);
  monEl.style.bottom = bottomPx + 'px';

  const monHeightPx = 5 * 16 * scale;
  bubble.style.bottom = (bottomPx + monHeightPx + 8) + 'px';
}

function onMonsterReached(){
  cancelAnimationFrame(monsterRafId);
  showFeedback('ğŸ’€ ã‚„ã‚‰ã‚ŒãŸï¼','ng');
  setTimeout(()=>{ if(gameActive) loadWord(); }, 700);
}

// =============================================
//  ã‚­ãƒ¼å…¥åŠ›
// =============================================
document.addEventListener('keydown', e=>{
  if(!gameActive) return;
  if(e.key==='Tab'||e.key==='Enter'){ e.preventDefault(); return; }

  const ch = e.key===' ' ? ' ' : e.key.toLowerCase();
  if(ch.length!==1) return;

  const expected=currentWord.romaji[charIdx];

  const kid=ch===' '?'key-space':'key-'+ch;
  const kel=document.getElementById(kid);
  if(kel){ kel.classList.add('pressed'); setTimeout(()=>kel.classList.remove('pressed'),100); }

  totalTyped++;

  if(!wordStarted && ch===expected){
    wordStartTime=performance.now();
    wordStarted=true;
  }

  if(ch===expected){
    correctTyped++;
    const cb=document.getElementById('cb-'+charIdx);
    if(cb){ cb.textContent=ch.toUpperCase(); cb.className='char-box ok'; }

    charIdx++;
    if(charIdx>=currentWord.romaji.length){
      onWordComplete();
    } else {
      const ncb=document.getElementById('cb-'+charIdx);
      if(ncb) ncb.classList.add('current');
      updateRomajiGuide();
      highlightNextKey();
    }
  } else {
    const cb=document.getElementById('cb-'+charIdx);
    if(cb){
      cb.textContent=ch.toUpperCase();
      cb.className='char-box ng';
      setTimeout(()=>{ if(cb){ cb.textContent=''; cb.className='char-box current'; } },380);
    }
    const monEl=document.getElementById('monster');
    monEl.classList.add('hurt');
    setTimeout(()=>monEl.classList.remove('hurt'),350);

    applyPenalty();
    showFeedback('âŒ ãƒŸã‚¹ï¼ï¼2ç§’','ng');
    if(combo>0){
      combo=0;
      updateComboUI(true);
    }
  }

  updateHUD();
});

// =============================================
//  å˜èªã‚¯ãƒªã‚¢
// =============================================
function onWordComplete(){
  cancelAnimationFrame(monsterRafId);
  kills++;
  combo++;

  const elapsed=(performance.now()-wordStartTime)/1000;
  let speedMult, speedLabel;
  if      (elapsed<=2)  { speedMult=3.0; speedLabel='âš¡Ã—3.0'; }
  else if (elapsed<=4)  { speedMult=2.0; speedLabel='ğŸ”¥Ã—2.0'; }
  else if (elapsed<=6)  { speedMult=1.5; speedLabel='âœ¨Ã—1.5'; }
  else if (elapsed<=10) { speedMult=1.0; speedLabel='Ã—1.0'; }
  else                  { speedMult=0.7; speedLabel='Ã—0.7'; }

  let comboMult, comboLabel;
  if      (combo>=10) { comboMult=3.0; comboLabel='ğŸ”¥ã‚³ãƒ³ãƒœÃ—3.0'; }
  else if (combo>=5)  { comboMult=2.0; comboLabel='ğŸ’¥ã‚³ãƒ³ãƒœÃ—2.0'; }
  else if (combo>=3)  { comboMult=1.5; comboLabel='â­ã‚³ãƒ³ãƒœÃ—1.5'; }
  else                { comboMult=1.0; comboLabel=''; }

  const base=currentWord.romaji.length*20;
  const pts=Math.max(10, Math.round(base * speedMult * comboMult));
  score+=pts;

  const monEl=document.getElementById('monster');
  const bubble=document.getElementById('word-bubble');
  monEl.classList.add('explode');
  bubble.style.opacity='0';

  const labelParts=[comboLabel, speedLabel].filter(Boolean).join(' ');
  showFeedback(`ğŸ’¥ ã‚„ã£ã¤ã‘ãŸï¼ ï¼‹${pts}pt${labelParts?' ('+labelParts+')':''}`, 'ok');
  spawnParticles();
  updateComboUI(false);
  updateHUD();
  showScorePopup(pts);

  setTimeout(()=>{
    if(gameActive) loadWord();
  }, 650);
}

// =============================================
//  ã‚³ãƒ³ãƒœUIæ›´æ–°
// =============================================
function updateComboUI(reset){
  const el=document.getElementById('combo-value');
  el.textContent=combo;
  el.classList.remove('level1','level2','level3','bump');
  if(combo>=10)     el.classList.add('level3');
  else if(combo>=5) el.classList.add('level2');
  else if(combo>=3) el.classList.add('level1');

  if(!reset && combo>0){
    void el.offsetWidth;
    el.classList.add('bump');
  }

  if(reset){
    const rf=document.getElementById('combo-reset-flash');
    rf.classList.remove('show');
    void rf.offsetWidth;
    rf.classList.add('show');
  }
}

// =============================================
//  ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—
// =============================================
function showScorePopup(pts){
  const stage=document.getElementById('monster-stage');
  const rect=stage.getBoundingClientRect();
  const p=document.createElement('div');
  p.className='score-popup';
  p.textContent='+'+pts+'pt';
  p.style.left=(rect.left+rect.width/2-30)+'px';
  p.style.top=(rect.top+20)+'px';
  if(combo>=10)     p.style.color='var(--red)';
  else if(combo>=5) p.style.color='var(--accent2)';
  else if(combo>=3) p.style.color='var(--green)';
  document.body.appendChild(p);
  setTimeout(()=>p.remove(),950);
}

// =============================================
//  ã‚²ãƒ¼ãƒ çµ‚äº†
// =============================================
function endGame(){
  stopGame();
  const acc=totalTyped>0?Math.round(correctTyped/totalTyped*100):100;
  document.getElementById('final-score').textContent=score+'pt';
  document.getElementById('final-stats').textContent=
    `ãŸãŠã—ãŸæ•°ï¼š${kills}ä½“ã€€æ­£ç¢ºç‡ï¼š${acc}%ã€€ã‚¿ã‚¤ãƒ—æ•°ï¼š${totalTyped}`;
  document.getElementById('player-name').value='';
  document.getElementById('name-area').style.display='flex';
  renderRanking(null);
  showScreen('ranking-screen');
}

// =============================================
//  ãƒ©ãƒ³ã‚­ãƒ³ã‚°
// =============================================
const STORAGE_KEY='monster_typing_v3';
const CATEGORIES = [
  { id:'all',        label:'ğŸ² å…¨éƒ¨ã¾ãœã¾ãœ', color:'var(--accent)' },
  { id:'animals',    label:'ğŸ¾ å‹•ç‰©',         color:'var(--green)' },
  { id:'food',       label:'ğŸš é£Ÿã¹ç‰©',       color:'var(--accent2)' },
  { id:'prefectures',label:'ğŸ—¾ éƒ½é“åºœçœŒ',     color:'var(--yellow)' },
  { id:'english',    label:'ğŸ”¤ è‹±å˜èª',       color:'#90caf9' },
  { id:'words',      label:'ğŸ“š ã„ã‚ã„ã‚ãªè¨€è‘‰',color:'var(--accent3)' },
  { id:'sports',     label:'ğŸƒ ã‚¹ãƒãƒ¼ãƒ„',     color:'var(--green)' },
  { id:'proverbs',   label:'ğŸ“– ã“ã¨ã‚ã–',     color:'var(--f-ring)' },
  { id:'school',     label:'ğŸ’ å­¦æ ¡ãƒ»æ–‡æˆ¿å…·', color:'var(--f-pinky)' },
];
let selectedCategory = 'all';

function buildCategoryGrid(){
  const grid = document.getElementById('cat-grid');
  grid.innerHTML = '';
  CATEGORIES.forEach(cat => {
    const btn = document.createElement('button');
    btn.className = 'cat-btn' + (cat.id === selectedCategory ? ' selected' : '');
    btn.textContent = cat.label;
    btn.style.setProperty('--cat-color', cat.color);
    btn.onclick = () => selectCategory(cat.id);
    btn.id = 'cat-' + cat.id;
    grid.appendChild(btn);
  });
}

function selectCategory(id){
  selectedCategory = id;
  document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
  const btn = document.getElementById('cat-' + id);
  if(btn) btn.classList.add('selected');
}

function saveRanking(){
  const name=document.getElementById('player-name').value.trim()||'ã‚†ã†ã—ã‚ƒ';
  const acc=totalTyped>0?Math.round(correctTyped/totalTyped*100):100;
  const list=getStoredRanking();
  list.push({name, score, kills, acc});
  list.sort((a,b)=>b.score-a.score);
  const top=list.slice(0,10);
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(top)); }catch(e){}
  lastSavedScore=score;
  document.getElementById('name-area').style.display='none';
  renderRanking(score);
}

function getStoredRanking(){
  try{ return JSON.parse(localStorage.getItem(STORAGE_KEY))||[]; }
  catch{ return []; }
}

function renderRanking(highlightScore){
  const list=getStoredRanking();
  const el=document.getElementById('rank-list');
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  if(list.length===0){
    el.innerHTML='<p style="color:#546e7a;text-align:center;padding:16px">ã¾ã è¨˜éŒ²ãŒãªã„ã‚ˆï¼<br>ã‚²ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦ç™»éŒ²ã—ã‚ˆã†ï¼</p>';
    return;
  }
  let highlighted=false;
  el.innerHTML=list.map((r,i)=>{
    const isMe=highlightScore!==null && !highlighted && r.score===highlightScore;
    if(isMe) highlighted=true;
    return `<div class="rank-item ${isMe?'me':''}">
      <div class="rank-num">${i+1}</div>
      <div class="rank-medal">${medals[i]||''}</div>
      <div class="rank-name">${r.name}</div>
      <div class="rank-score">${r.score}pt</div>
      <div class="rank-acc">${r.acc}%</div>
    </div>`;
  }).join('');
}

// =============================================
//  UI ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
// =============================================
function updateHUD(){
  document.getElementById('score-value').textContent=score;
  document.getElementById('kill-value').textContent=kills;
  const acc=totalTyped>0?Math.round(correctTyped/totalTyped*100):100;
  document.getElementById('acc-value').textContent=acc+'%';
  document.getElementById('combo-value').textContent=combo;
}

function updateRomajiGuide(){
  if(!currentWord) return;
  const rom=currentWord.romaji;
  let html='';
  for(let i=0;i<rom.length;i++){
    if(i<charIdx)        html+=`<span class="done">${rom[i].toUpperCase()}</span>`;
    else if(i===charIdx) html+=`<span class="next">${rom[i].toUpperCase()}</span>`;
    else                 html+=`<span class="rest">${rom[i].toUpperCase()}</span>`;
  }
  document.getElementById('romaji-guide').innerHTML=html;
}

function highlightNextKey(){
  document.querySelectorAll('.key.active-key').forEach(el=>el.classList.remove('active-key'));
  if(!currentWord||charIdx>=currentWord.romaji.length) return;
  const ch=currentWord.romaji[charIdx];
  const kid=ch===' '?'key-space':'key-'+ch.toLowerCase();
  const el=document.getElementById(kid);
  if(el) el.classList.add('active-key');

  const fc=KEY_FINGER[ch.toLowerCase()]||'f-index';
  const color=FINGER_COLORS[fc];
  document.getElementById('next-key-hint').innerHTML=
    `æ¬¡ã®ã‚­ãƒ¼ï¼š<strong style="color:${color}">${ch.toUpperCase()}</strong>ã€€`+
    `<span class="finger-tag" style="background:${color}22;border:1px solid ${color};color:${color}">`+
    `${FINGER_NAMES[fc]}ã§ï¼</span>`;
}

function showFeedback(msg,type){
  const el=document.getElementById('feedback-msg');
  el.textContent=msg;
  el.className='feedback-msg '+type;
  clearTimeout(feedbackTimer);
  feedbackTimer=setTimeout(()=>clearFeedback(),1100);
}
function clearFeedback(){
  const el=document.getElementById('feedback-msg');
  el.textContent='';
  el.className='feedback-msg';
}

function spawnParticles(){
  const colors=['#69f0ae','#00e5ff','#ffd740','#ff6b35','#a855f7','#ff6b6b'];
  const stage=document.getElementById('monster-stage');
  const rect=stage.getBoundingClientRect();
  const cx=rect.left+rect.width/2, cy=rect.top+rect.height*0.5;
  for(let i=0;i<22;i++){
    const p=document.createElement('div');
    p.className='particle';
    const sz=Math.random()*13+5;
    const ang=Math.random()*Math.PI*2;
    const dist=Math.random()*140+40;
    p.style.cssText=`width:${sz}px;height:${sz}px;`+
      `background:${colors[i%colors.length]};`+
      `left:${cx}px;top:${cy}px;`+
      `--tx:${Math.cos(ang)*dist}px;--ty:${Math.sin(ang)*dist}px;`+
      `--dur:${(.4+Math.random()*.5).toFixed(2)}s;`;
    document.body.appendChild(p);
    setTimeout(()=>p.remove(),800);
  }
}

function shuffle(arr){
  const a=[...arr];
  for(let i=a.length-1;i>0;i--){
    const j=Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
  return a;
}

// =============================================
//  èµ·å‹•
// =============================================
initStars();
buildKeyboard();
buildCategoryGrid();
renderRanking(null);
showScreen('license-screen');
</script>
</body>
</html>
